// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String?
  nickname      String
  profileImage  String?
  role          UserRole  @default(FAN)
  provider      AuthProvider @default(LOCAL)
  providerId    String?
  isVerified    Boolean   @default(false)
  tokenVersion  Int       @default(0)  // Increment to invalidate all tokens

  // 본인인증 관련 필드
  phoneNumber       String?   @unique  // 인증된 휴대폰 번호
  realName          String?            // 실명 (본인인증 시 획득)
  birthDate         String?            // 생년월일 (YYYYMMDD)
  gender            Gender?            // 성별
  ci                String?   @unique  // 연계정보 (CI) - 본인확인 고유값
  di                String?            // 중복가입확인정보 (DI)
  identityVerifiedAt DateTime?         // 본인인증 완료 시각

  // 계정 잠금 관련 필드
  failedLoginAttempts Int       @default(0)  // 연속 로그인 실패 횟수
  lastFailedLoginAt   DateTime?              // 마지막 로그인 실패 시각
  lockedUntil         DateTime?              // 계정 잠금 해제 시각

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  wallet        Wallet?
  supports      Support[]        @relation("SupporterSupports")
  receivedSupports Support[]     @relation("ReceivedSupports")
  subscriptions Subscription[]   @relation("SubscriberSubscriptions")
  subscribers   Subscription[]   @relation("CreatorSubscriptions")
  campaigns     Campaign[]
  contributions CampaignContribution[]
  bookings      Booking[]
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  idolProfile   IdolProfile?
  notifications Notification[]
  refreshTokens RefreshToken[]
  identityVerifications IdentityVerification[]
  replyRequests ReplyRequest[]   @relation("RequesterRequests")
  creatorRequests ReplyRequest[] @relation("CreatorRequests")

  @@index([email])
  @@index([role])
  @@index([phoneNumber])
  @@index([ci])
}

enum Gender {
  MALE
  FEMALE
}

enum UserRole {
  FAN
  IDOL
  MAID
  ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
  APPLE
  KAKAO
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

// ==================== 본인인증 (Identity Verification) ====================

model IdentityVerification {
  id            String                     @id @default(uuid())
  userId        String
  user          User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider      VerificationProvider       @default(KAKAO)
  status        VerificationStatus         @default(PENDING)
  txId          String?                    @unique  // 카카오 본인인증 트랜잭션 ID

  // 인증 요청 정보
  requestedAt   DateTime                   @default(now())
  completedAt   DateTime?

  // 인증 결과 (성공 시)
  phoneNumber   String?                    // 마스킹된 번호 (저장용)
  phoneCarrier  String?                    // 통신사
  realName      String?                    // 마스킹된 이름 (저장용)
  birthDate     String?                    // 생년월일 (YYYYMMDD)
  gender        Gender?
  nationality   String?                    // 내국인/외국인
  ci            String?                    // CI (해시된 값만 저장)

  // 실패 정보
  errorCode     String?
  errorMessage  String?

  // 메타데이터
  ipAddress     String?
  userAgent     String?
  deviceInfo    Json?

  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt

  @@index([userId])
  @@index([txId])
  @@index([status])
}

enum VerificationProvider {
  KAKAO
  PASS
  NAVER
  TOSS
}

enum VerificationStatus {
  PENDING     // 인증 대기
  IN_PROGRESS // 인증 진행 중
  COMPLETED   // 인증 완료
  FAILED      // 인증 실패
  EXPIRED     // 인증 만료
  CANCELLED   // 인증 취소
}

// ==================== IDOL/MAID PROFILE ====================

model IdolProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stageName       String
  introduction    String?
  category        IdolCategory
  cafeName        String?
  cafeAddress     String?
  headerImage     String?
  galleryImages   String[]
  socialLinks     Json?
  isVerified      Boolean  @default(false)
  totalSupport    Decimal  @default(0) @db.Decimal(15, 2)
  supporterCount  Int      @default(0)
  ranking         Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  schedules       Schedule[]
  tiers           SubscriptionTier[]
  replyProducts   ReplyProduct[]
  slotPolicy      ReplySlotPolicy?

  @@index([category])
  @@index([ranking])
}

enum IdolCategory {
  UNDERGROUND_IDOL
  MAID_CAFE
  COSPLAYER
  VTuber
  OTHER
}

model Schedule {
  id            String   @id @default(uuid())
  idolProfileId String
  idolProfile   IdolProfile @relation(fields: [idolProfileId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  location      String?
  startTime     DateTime
  endTime       DateTime
  isPublic      Boolean  @default(true)
  createdAt     DateTime @default(now())

  @@index([idolProfileId])
  @@index([startTime])
}

// ==================== WALLET & PAYMENT ====================

model Wallet {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance      Decimal  @default(0) @db.Decimal(15, 2)
  currency     String   @default("KRW")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  transactions Transaction[]
}

model Transaction {
  id            String          @id @default(uuid())
  walletId      String
  wallet        Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type          TransactionType
  amount        Decimal         @db.Decimal(15, 2)
  balanceBefore Decimal         @db.Decimal(15, 2)
  balanceAfter  Decimal         @db.Decimal(15, 2)
  description   String?
  referenceId   String?
  referenceType String?
  status        TransactionStatus @default(COMPLETED)
  createdAt     DateTime        @default(now())

  @@index([walletId])
  @@index([createdAt])
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  SUPPORT_SENT
  SUPPORT_RECEIVED
  SUBSCRIPTION_PAYMENT
  CAMPAIGN_CONTRIBUTION
  REFUND
  REPLY_REQUEST_ESCROW     // 리프 요청 에스크로 결제
  REPLY_REQUEST_RELEASE    // 리프 납품 후 크리에이터에게 정산
  REPLY_REQUEST_REFUND     // 리프 환불
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id              String        @id @default(uuid())
  userId          String
  amount          Decimal       @db.Decimal(15, 2)
  currency        String        @default("KRW")
  provider        PaymentProvider
  providerPaymentId String?
  status          PaymentStatus @default(PENDING)
  type            PaymentType
  referenceId     String?
  referenceType   String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([providerPaymentId])
  @@index([status])
}

enum PaymentProvider {
  STRIPE
  GOOGLE_PLAY
  APP_STORE
  TOSS
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentType {
  WALLET_CHARGE
  SUBSCRIPTION
  CAMPAIGN
  DIRECT_SUPPORT
}

// ==================== SUPPORT (후원) ====================

model Support {
  id          String   @id @default(uuid())
  supporterId String
  supporter   User     @relation("SupporterSupports", fields: [supporterId], references: [id])
  receiverId  String
  receiver    User     @relation("ReceivedSupports", fields: [receiverId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  message     String?
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([supporterId])
  @@index([receiverId])
  @@index([createdAt])
}

// ==================== SUBSCRIPTION (구독) ====================

model SubscriptionTier {
  id            String   @id @default(uuid())
  idolProfileId String
  idolProfile   IdolProfile @relation(fields: [idolProfileId], references: [id], onDelete: Cascade)
  name          String
  price         Decimal  @db.Decimal(15, 2)
  benefits      String[]
  maxSubscribers Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions Subscription[]

  @@index([idolProfileId])
}

model Subscription {
  id           String             @id @default(uuid())
  subscriberId String
  subscriber   User               @relation("SubscriberSubscriptions", fields: [subscriberId], references: [id])
  creatorId    String
  creator      User               @relation("CreatorSubscriptions", fields: [creatorId], references: [id])
  tierId       String
  tier         SubscriptionTier   @relation(fields: [tierId], references: [id])
  status       SubscriptionStatus @default(ACTIVE)
  startDate    DateTime           @default(now())
  endDate      DateTime?
  renewalDate  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@unique([subscriberId, creatorId])
  @@index([subscriberId])
  @@index([creatorId])
  @@index([status])
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

// ==================== CAMPAIGN (펀딩) ====================

model Campaign {
  id            String         @id @default(uuid())
  creatorId     String
  creator       User           @relation(fields: [creatorId], references: [id])
  title         String
  description   String
  coverImage    String?
  goalAmount    Decimal        @db.Decimal(15, 2)
  currentAmount Decimal        @default(0) @db.Decimal(15, 2)
  startDate     DateTime
  endDate       DateTime
  status        CampaignStatus @default(DRAFT)
  rewards       Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  contributions CampaignContribution[]

  @@index([creatorId])
  @@index([status])
  @@index([endDate])
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  COMPLETED
  FAILED
  CANCELLED
}

model CampaignContribution {
  id          String   @id @default(uuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  amount      Decimal  @db.Decimal(15, 2)
  rewardTier  String?
  message     String?
  isAnonymous Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([campaignId])
  @@index([userId])
}

// ==================== BOOKING (메이드카페 예약) ====================

model Booking {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  cafeName      String
  cafeAddress   String?
  date          DateTime
  timeSlot      String
  numberOfGuests Int          @default(1)
  specialRequest String?
  status        BookingStatus @default(PENDING)
  confirmationCode String?    @unique
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([date])
  @@index([status])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

// ==================== COMMUNITY ====================

model Post {
  id          String   @id @default(uuid())
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  title       String?
  content     String
  images      String[]
  visibility  PostVisibility @default(PUBLIC)
  isPinned    Boolean  @default(false)
  likeCount   Int      @default(0)
  commentCount Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  comments    Comment[]
  likes       Like[]

  @@index([authorId])
  @@index([createdAt])
  @@index([visibility])
}

enum PostVisibility {
  PUBLIC
  SUBSCRIBERS_ONLY
  TIER_SPECIFIC
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  content   String
  parentId  String?
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// ==================== NOTIFICATION ====================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  SUPPORT_RECEIVED
  NEW_SUBSCRIBER
  SUBSCRIPTION_RENEWED
  CAMPAIGN_UPDATE
  CAMPAIGN_GOAL_REACHED
  BOOKING_CONFIRMED
  BOOKING_REMINDER
  NEW_POST
  NEW_COMMENT
  SYSTEM
  REPLY_REQUEST_RECEIVED
  REPLY_REQUEST_DELIVERED
  REPLY_REQUEST_EXPIRED
  REPLY_REQUEST_REFUNDED
}

// ==================== REPLY REQUEST (유료 리프 시스템) ====================

// 리프 상품 (형식/콘텐츠 타입)
model ReplyProduct {
  id            String            @id @default(uuid())
  idolProfileId String
  idolProfile   IdolProfile       @relation(fields: [idolProfileId], references: [id], onDelete: Cascade)
  name          String            // 예: "텍스트 메시지", "보이스 메시지", "사진", "영상"
  description   String?
  contentType   ReplyContentType
  basePrice     Decimal           @db.Decimal(15, 2)
  isActive      Boolean           @default(true)
  sortOrder     Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  slaOptions    ReplySLA[]
  requests      ReplyRequest[]

  @@index([idolProfileId])
  @@index([contentType])
}

enum ReplyContentType {
  TEXT
  VOICE
  PHOTO
  VIDEO
}

// SLA 옵션 (납품 기한별 가격 차등)
model ReplySLA {
  id              String        @id @default(uuid())
  replyProductId  String
  replyProduct    ReplyProduct  @relation(fields: [replyProductId], references: [id], onDelete: Cascade)
  name            String        // 예: "Standard", "Express", "Priority"
  deadlineHours   Int           // 48, 24, 12 등
  priceMultiplier Decimal       @db.Decimal(5, 2) @default(1.00) // 기본가격 대비 배수
  isActive        Boolean       @default(true)
  sortOrder       Int           @default(0)
  createdAt       DateTime      @default(now())

  requests        ReplyRequest[]

  @@index([replyProductId])
}

// 슬롯 정책 (일일 요청 제한)
model ReplySlotPolicy {
  id              String      @id @default(uuid())
  idolProfileId   String      @unique
  idolProfile     IdolProfile @relation(fields: [idolProfileId], references: [id], onDelete: Cascade)
  dailySlotLimit  Int         @default(10)  // 하루 최대 접수 가능 수
  isAutoClose     Boolean     @default(true) // 슬롯 소진 시 자동 마감
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// 리프 요청 (핵심 거래 모델)
model ReplyRequest {
  id              String              @id @default(uuid())
  requesterId     String
  requester       User                @relation("RequesterRequests", fields: [requesterId], references: [id])
  creatorId       String
  creator         User                @relation("CreatorRequests", fields: [creatorId], references: [id])
  productId       String
  product         ReplyProduct        @relation(fields: [productId], references: [id])
  slaId           String
  sla             ReplySLA            @relation(fields: [slaId], references: [id])

  // 요청 내용
  requestMessage  String              // 팬의 요청 메시지
  isAnonymous     Boolean             @default(false)

  // 가격/결제
  basePrice       Decimal             @db.Decimal(15, 2)
  slaPrice        Decimal             @db.Decimal(15, 2)
  totalPrice      Decimal             @db.Decimal(15, 2)
  escrowAmount    Decimal             @db.Decimal(15, 2) // 에스크로 금액

  // 상태 관리
  status          ReplyRequestStatus  @default(PENDING_PAYMENT)
  queuePosition   Int?                // 큐 순서

  // 시간 추적
  paidAt          DateTime?           // 결제 완료 시간
  queuedAt        DateTime?           // 큐 진입 시간
  startedAt       DateTime?           // 작업 시작 시간
  deadlineAt      DateTime?           // SLA 마감 시간
  deliveredAt     DateTime?           // 납품 완료 시간
  expiredAt       DateTime?           // 만료 시간
  refundedAt      DateTime?           // 환불 시간

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  delivery        ReplyDelivery?
  refund          ReplyRefund?

  @@index([requesterId])
  @@index([creatorId])
  @@index([status])
  @@index([deadlineAt])
  @@index([createdAt])
}

enum ReplyRequestStatus {
  PENDING_PAYMENT   // 결제 대기
  QUEUED            // 큐 대기 (결제 완료)
  IN_PROGRESS       // 작업 중
  DELIVERED         // 납품 완료
  EXPIRED           // SLA 만료
  REFUNDED          // 환불 완료
  REJECTED          // 크리에이터 거절
  CANCELLED         // 팬 취소 (결제 전)
}

// 납품물
model ReplyDelivery {
  id              String        @id @default(uuid())
  replyRequestId  String        @unique
  replyRequest    ReplyRequest  @relation(fields: [replyRequestId], references: [id], onDelete: Cascade)

  // 콘텐츠
  textContent     String?       // 텍스트 답장
  voiceUrl        String?       // 음성 파일 URL
  photoUrls       String[]      // 사진 URL 배열
  videoUrl        String?       // 영상 URL

  // 메타데이터
  duration        Int?          // 음성/영상 길이(초)
  creatorNote     String?       // 크리에이터 메모

  // 팬 피드백
  fanRating       Int?          // 1-5 별점
  fanFeedback     String?       // 피드백 메시지
  isPublicAllowed Boolean       @default(false) // 공개 허용 여부 (하이라이트용)

  createdAt       DateTime      @default(now())

  @@index([replyRequestId])
}

// 환불 기록
model ReplyRefund {
  id              String            @id @default(uuid())
  replyRequestId  String            @unique
  replyRequest    ReplyRequest      @relation(fields: [replyRequestId], references: [id], onDelete: Cascade)

  reason          ReplyRefundReason
  amount          Decimal           @db.Decimal(15, 2)
  description     String?
  processedBy     String?           // 처리자 (시스템/관리자 ID)

  createdAt       DateTime          @default(now())

  @@index([replyRequestId])
}

enum ReplyRefundReason {
  SLA_EXPIRED       // SLA 만료
  CREATOR_REJECTED  // 크리에이터 거절
  FAN_CANCELLED     // 팬 취소 (결제 후 일정 시간 내)
  CONTENT_VIOLATION // 콘텐츠 정책 위반
  DISPUTE_RESOLVED  // 분쟁 해결
  ADMIN_REFUND      // 관리자 환불
}
